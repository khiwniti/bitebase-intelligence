/**
 * Test script for advanced AI intelligence features
 */

const axios = require('axios');

const BASE_URL = 'http://localhost:12001';

// Test cases for advanced AI intelligence
const advancedTestCases = [
  // Predictive Analytics Tests
  {
    message: 'Can you predict my restaurant revenue for the next 3 months?',
    language: 'en',
    expectedIntent: 'predictive_analytics',
    description: 'English predictive analytics request'
  },
  {
    message: '‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö',
    language: 'th',
    expectedIntent: 'predictive_analytics',
    description: 'Thai predictive analytics request'
  },

  // Customer Intelligence Tests
  {
    message: 'Analyze my customer behavior and segments',
    language: 'en',
    expectedIntent: 'customer_intelligence',
    description: 'English customer intelligence request'
  },
  {
    message: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ú‡∏°‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö',
    language: 'th',
    expectedIntent: 'customer_intelligence',
    description: 'Thai customer intelligence request'
  },

  // Competitive Intelligence Tests
  {
    message: 'Give me competitive analysis and market positioning insights',
    language: 'en',
    expectedIntent: 'competitive_intelligence',
    description: 'English competitive intelligence request'
  },
  {
    message: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ú‡∏°',
    language: 'th',
    expectedIntent: 'competitive_intelligence',
    description: 'Thai competitive intelligence request'
  },

  // Menu Optimization Tests
  {
    message: 'Help me optimize my menu for better profitability',
    language: 'en',
    expectedIntent: 'menu_optimization',
    description: 'English menu optimization request'
  },
  {
    message: '‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≥‡πÑ‡∏£‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö',
    language: 'th',
    expectedIntent: 'menu_optimization',
    description: 'Thai menu optimization request'
  },

  // Operational Intelligence Tests
  {
    message: 'Analyze my operational efficiency and suggest improvements',
    language: 'en',
    expectedIntent: 'operational_intelligence',
    description: 'English operational intelligence request'
  },
  {
    message: '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á',
    language: 'th',
    expectedIntent: 'operational_intelligence',
    description: 'Thai operational intelligence request'
  },

  // Strategic Intelligence Tests
  {
    message: 'What are my strategic growth opportunities and expansion plans?',
    language: 'en',
    expectedIntent: 'strategic_intelligence',
    description: 'English strategic intelligence request'
  },
  {
    message: '‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö',
    language: 'th',
    expectedIntent: 'strategic_intelligence',
    description: 'Thai strategic intelligence request'
  }
];

async function testAdvancedAIIntelligence(testCase) {
  console.log(`\nüß† Testing: ${testCase.description}`);
  console.log(`üìù Message: "${testCase.message}"`);
  console.log(`üåê Expected Language: ${testCase.language}`);
  console.log(`üéØ Expected Intent: ${testCase.expectedIntent}`);
  
  try {
    const response = await axios.post(`${BASE_URL}/api/ai/chat`, {
      message: testCase.message,
      user_id: 'advanced_test_user',
      context: {
        language: testCase.language,
        userId: 'test_restaurant_123'
      }
    });

    if (response.data.success) {
      const aiResponse = response.data.data;
      
      console.log(`‚úÖ Response received:`);
      console.log(`   üåê Detected Language: ${aiResponse.language}`);
      console.log(`   üéØ Detected Intent: ${aiResponse.intent}`);
      console.log(`   ü§ñ Model: ${aiResponse.model || 'N/A'}`);
      console.log(`   üìä Data Source: ${aiResponse.data_source}`);
      console.log(`   üí¨ Response Length: ${aiResponse.response?.length || 0} characters`);
      
      // Show first 300 characters of response
      if (aiResponse.response) {
        const preview = aiResponse.response.substring(0, 300);
        console.log(`   üìÑ Response Preview: "${preview}${aiResponse.response.length > 300 ? '...' : ''}"`);
      }
      
      // Show suggestions
      if (aiResponse.suggestions && aiResponse.suggestions.length > 0) {
        console.log(`   üí° Suggestions: ${aiResponse.suggestions.join(', ')}`);
      }
      
      // Validate results
      let validationResults = [];
      
      if (aiResponse.language === testCase.language) {
        validationResults.push('‚úÖ Language detection correct');
      } else {
        validationResults.push(`‚ùå Language detection wrong (got ${aiResponse.language}, expected ${testCase.language})`);
      }
      
      if (aiResponse.intent === testCase.expectedIntent) {
        validationResults.push('‚úÖ Advanced intent detection correct');
      } else {
        validationResults.push(`‚ùå Intent detection wrong (got ${aiResponse.intent}, expected ${testCase.expectedIntent})`);
      }
      
      // Check for advanced intelligence indicators
      const content = aiResponse.response?.toLowerCase() || '';
      const hasAdvancedIntelligence = content.includes('predict') || 
                                    content.includes('forecast') ||
                                    content.includes('segment') ||
                                    content.includes('competitive') ||
                                    content.includes('optimization') ||
                                    content.includes('strategic') ||
                                    content.includes('‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢') ||
                                    content.includes('‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå') ||
                                    content.includes('‡∏Å‡∏•‡∏∏‡πà‡∏°') ||
                                    content.includes('‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå');
      
      if (hasAdvancedIntelligence) {
        validationResults.push('‚úÖ Advanced intelligence content detected');
      } else {
        validationResults.push('‚ö†Ô∏è Advanced intelligence content not clearly evident');
      }
      
      // Check for Alex persona
      const hasPersonality = content.includes('alex') || 
                           content.includes('‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏ã‡πå') ||
                           content.includes('üòä') ||
                           content.includes('üí™') ||
                           content.includes('üéØ');
      
      if (hasPersonality) {
        validationResults.push('‚úÖ Alex persona maintained');
      } else {
        validationResults.push('‚ö†Ô∏è Alex persona not clearly evident');
      }
      
      console.log(`   üîç Validation Results:`);
      validationResults.forEach(result => console.log(`      ${result}`));
      
      return {
        success: true,
        languageCorrect: aiResponse.language === testCase.language,
        intentCorrect: aiResponse.intent === testCase.expectedIntent,
        hasAdvancedIntelligence: hasAdvancedIntelligence,
        hasPersonality: hasPersonality,
        responseLength: aiResponse.response?.length || 0
      };
      
    } else {
      console.log(`‚ùå API Error: ${response.data.error}`);
      return { success: false, error: response.data.error };
    }
    
  } catch (error) {
    console.log(`‚ùå Request failed: ${error.response?.data?.error || error.message}`);
    return { success: false, error: error.message };
  }
}

async function testMCPTools() {
  console.log('\nüîß Testing MCP Advanced Intelligence Tools...');
  
  const tools = [
    'get_predictive_analytics',
    'get_customer_intelligence',
    'get_competitive_intelligence',
    'get_menu_optimization',
    'get_operational_intelligence',
    'get_strategic_intelligence'
  ];
  
  for (const tool of tools) {
    try {
      const response = await axios.post(`${BASE_URL}/api/mcp/execute`, {
        tool_name: tool,
        parameters: {
          restaurant_id: 'test_restaurant_123'
        }
      });
      
      if (response.data.success) {
        console.log(`   ‚úÖ ${tool}: Working`);
        console.log(`      Data source: ${response.data.result.data_source || 'N/A'}`);
      } else {
        console.log(`   ‚ùå ${tool}: Failed - ${response.data.error}`);
      }
    } catch (error) {
      console.log(`   ‚ùå ${tool}: Error - ${error.message}`);
    }
  }
}

async function runAdvancedIntelligenceTests() {
  console.log('üß† Starting Advanced AI Intelligence Test Suite');
  console.log('=' .repeat(80));
  
  let totalTests = 0;
  let passedTests = 0;
  let languageCorrect = 0;
  let intentCorrect = 0;
  let advancedIntelligenceDetected = 0;
  let personalityDetected = 0;
  
  // Test MCP tools first
  await testMCPTools();
  
  // Test advanced conversation cases
  for (const testCase of advancedTestCases) {
    const result = await testAdvancedAIIntelligence(testCase);
    totalTests++;
    
    if (result.success) {
      passedTests++;
      if (result.languageCorrect) languageCorrect++;
      if (result.intentCorrect) intentCorrect++;
      if (result.hasAdvancedIntelligence) advancedIntelligenceDetected++;
      if (result.hasPersonality) personalityDetected++;
    }
  }
  
  console.log('\n' + '=' .repeat(80));
  console.log('üìä Advanced AI Intelligence Test Results Summary:');
  console.log(`‚úÖ Tests Passed: ${passedTests}/${totalTests} (${Math.round((passedTests/totalTests)*100)}%)`);
  console.log(`üåê Language Detection: ${languageCorrect}/${totalTests} (${Math.round((languageCorrect/totalTests)*100)}%)`);
  console.log(`üéØ Advanced Intent Detection: ${intentCorrect}/${totalTests} (${Math.round((intentCorrect/totalTests)*100)}%)`);
  console.log(`üß† Advanced Intelligence: ${advancedIntelligenceDetected}/${totalTests} (${Math.round((advancedIntelligenceDetected/totalTests)*100)}%)`);
  console.log(`üë§ Alex Persona: ${personalityDetected}/${totalTests} (${Math.round((personalityDetected/totalTests)*100)}%)`);
  
  if (passedTests === totalTests && intentCorrect >= totalTests * 0.8 && advancedIntelligenceDetected >= totalTests * 0.7) {
    console.log('\nüéâ Advanced AI Intelligence system is working excellently!');
    console.log('üß† Predictive analytics, customer intelligence, and strategic insights are active');
    console.log('ü§ñ Alex persona is functioning with advanced capabilities');
    console.log('üåè Bilingual advanced intelligence is operational');
  } else if (passedTests >= totalTests * 0.7) {
    console.log('\n‚úÖ Advanced AI Intelligence system is working well with minor improvements needed');
  } else {
    console.log('\n‚ö†Ô∏è Advanced AI Intelligence system needs attention - some features may not be working properly');
  }
  
  console.log('\nüîÆ Advanced Features Available:');
  console.log('   üìà Predictive Analytics - Revenue forecasting and trend analysis');
  console.log('   üë• Customer Intelligence - Behavioral analysis and segmentation');
  console.log('   üèÜ Competitive Intelligence - Market positioning and competitor analysis');
  console.log('   üçΩÔ∏è Menu Optimization - Profitability and engineering insights');
  console.log('   ‚öôÔ∏è Operational Intelligence - Efficiency analysis and recommendations');
  console.log('   üéØ Strategic Intelligence - Growth opportunities and strategic planning');
}

// Run the tests
runAdvancedIntelligenceTests().catch(console.error);
